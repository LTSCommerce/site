/**
 * Generate Snippets Module
 *
 * Reads all files from code-snippets/ and generates src/data/snippets.ts
 * with HTML-escaped content. This replaces the {{SNIPPET:path}} placeholders
 * used in article HTML content.
 *
 * Usage: node scripts/generate-snippets.mjs
 * (Run before tsc + vite build)
 */

import { readFileSync, writeFileSync, readdirSync, statSync } from 'node:fs';
import { resolve, join, relative, dirname } from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const snippetsDir = resolve(__dirname, '../code-snippets');
const outputFile = resolve(__dirname, '../src/data/snippets.ts');

function escapeHtml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function walkDir(dir, base = dir) {
  const entries = [];
  for (const name of readdirSync(dir)) {
    const full = join(dir, name);
    if (statSync(full).isDirectory()) {
      entries.push(...walkDir(full, base));
    } else {
      entries.push(full);
    }
  }
  return entries;
}

const files = walkDir(snippetsDir);
console.log(`Generating snippets from ${files.length} files...`);

const lines = [
  '/**',
  ' * Auto-generated by scripts/generate-snippets.mjs',
  ' * Do not edit manually â€” run the build script to regenerate.',
  ' */',
  '',
  '/** HTML-escaped code snippet content keyed by relative path */',
  'export const SNIPPETS: Readonly<Record<string, string>> = {',
];

for (const file of files.sort()) {
  const key = relative(snippetsDir, file).replace(/\\/g, '/');
  const content = readFileSync(file, 'utf-8');
  const escaped = escapeHtml(content);
  // Use JSON.stringify to safely encode the string as a JS string literal
  lines.push(`  ${JSON.stringify(key)}: ${JSON.stringify(escaped)},`);
}

lines.push('};', '');

writeFileSync(outputFile, lines.join('\n'));
console.log(`Written: src/data/snippets.ts (${files.length} snippets)`);
